---
layout: post
title:  "Langdon OA Corals"
author: "Patrick M Kiel"
date: '`r Sys.Date()`'
categories: [research]
description: "Skeletal density analysis of Acropora cervicornis reared under ocean acidification and control experiment conditions."
output:
  md_document:
    variant: gfm
    preserve_yaml: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, 
  encoding = encoding, 
  output_file = paste0(Sys.Date(), "-",
                        gsub(pattern = "\\.Rmd$",
                              "", basename(inputFile))
                        ,".md"), 
  output_dir = "../_posts") })
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#load packages
library(tidyverse)
library(kableExtra)
library(readxl)
library(ggpubr)
library(rstatix)

base_dir <- "C:/Users/pkiel/Github/notebook/" # i.e. where the jekyll blog is on the hard drive.
base_url <- "/notebook/" # subdirectory of patrickmkiel.com
fig_path <- "images/"

# Set base directories
knitr::opts_knit$set(base.dir = base_dir, base.url = base_url)

# Set figure directories
knitr::opts_chunk$set(fig.path = fig_path,
                    cache.path = '../cache/',
                    message=FALSE, warning=FALSE,
                    cache = FALSE)
```

```{r load Langdon Data}
treatment <- read_excel("~/Grad School/ULink 2022/LangdonCorals/coral_ID_linearGrowth.xlsx", 
                        col_types = c("text", "text", "skip")) %>%
  rename(treatment=Treatment)

genotype <- read_excel("~/Grad School/ULink 2022/LangdonCorals/coral_ID_linearGrowth.xlsx", 
                       sheet = "genotypes")

LE <- read_excel("~/Grad School/ULink 2022/LangdonCorals/coral_ID_linearGrowth.xlsx", 
                 sheet = "vertical extension",
                 col_types = c("date","skip", "skip", 
                               "numeric", "text","skip",
                               "text", "text", "numeric", 
                               "skip","skip", "skip")) %>%
  drop_na(Height_mm) %>%
  group_by(Coral) %>%
  arrange(Date) %>%
  summarise(growth = last(Height_mm)-first(Height_mm),
            initialH = first(Height_mm)/10,
            days = as.numeric(last(Date)-first(Date)),
            prod = growth/initialH/days) %>%
  left_join(treatment,
            by=c("Coral"="Coral.ID")) %>%
  left_join(genotype,
            by=c("Coral"="coral.id"))

```

```{r load CT data}
ctDataString <- list.files('~/Grad School/ULink 2022/LangdonCorals/materialData/', full.names = T)

ct <- lapply(ctDataString, function(x) {
  read.csv(x, skip = 1) %>%
    filter(Material != 'Coral') %>%
    select(2, 5, 9:11) %>%
    slice(2,3) %>%
    mutate(coral = case_when(
                    str_detect(x,
                              '(?<=REDDOT_)(.*)(?=_f|_h)') ~ 
                        str_extract(x,'(?<=REDDOT_)(.*)(?=_f|_h)'),
                    TRUE ~ str_extract(x,'(?<=REDDOT_)(.*)(?=.M)')),
           holes = case_when(grepl('hole',
                                   x,
                                   ignore.case = T) ~ 'filled',
                             TRUE ~ 'open'))
                             
}) %>%
  bind_rows() %>%
  magrittr::set_names(c("material",
                        "volume",
                        "density",
                        "deviation",
                        "variance",
                        "coral",
                        "holes")) %>%
  left_join(treatment, 
            by=c("coral"="Coral.ID")) %>%
  mutate(across(density:deviation,
                ~ .x*0.0007+0.6174),
         variance = deviation^2) %>%
  filter(holes == 'filled')

```

# Overview

Here, I analyze the 10 coral skeletons grown under OA and ambient conditions. I investigate the response of skeletal density to OA treatment and begin to look at genotype variability within the control group.

# Linear Growth Analysis

```{r}
LE <- LE %>%
  filter(Coral %in% ct$coral)

LE %>%
  ggplot(aes(treatment,initialH)) +
  geom_boxplot() +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() +
  labs(y = "Initial Height (cm)",
       title = "Initial height not significantly different")

LE %>%
  ggplot(aes(treatment,growth)) +
  geom_boxplot() +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() +
  labs(y = "Vertical Extension (mm)",
       title = "Vertical extension not significantly different, p=0.07")

LE %>%
  ggplot(aes(treatment,prod)) +
  geom_boxplot() +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() +
  labs(y = expression(paste("Standardized Growth (mm ", cm^-1," ", d^-1,")")),
       title = "Standardized vertical extension is not Significantly different")
```

## Statistical Testing

```{r}
LE_test <- LE %>%
  t_test(growth ~ treatment, var.equal=F)

ggqqplot(LE, x = "growth", facet.by = "treatment") +
  labs(title = "Data are approximately normal")
LE %>%
  group_by(treatment) %>%
  shapiro_test(growth)
LE %>%
  levene_test(growth ~ treatment)

LE_test %>%
  kbl(align = 'c',
    digits = 3,
    caption = "T-Test Results of Vertical Extension") %>%
  kable_classic() %>%
  row_spec(0, bold = T)


LE %>%
  cohens_d(growth ~ treatment, var.equal=F) %>%
  kbl(align = 'c',
    digits = 3,
    caption = "Effect Size Results of Vertical Extension") %>%
  kable_classic() %>%
  row_spec(0, bold = T)
```

We cannot assume homogeneity of variance as p < 0.05 for the Levene Test (p=0.0496). So we'll use the Welch's T test.

The mean growth in the HCO2 group was `r round(mean(LE$growth[which(LE$treatment=='HCO2')] ,na.rm=T),2)` mm (SD = `r round(sd(LE$growth[which(LE$treatment=='HCO2')] ,na.rm=T),2)`mm), whereas the mean in LCO2 group was `r round(mean(LE$growth[which(LE$treatment=='LCO2')] ,na.rm=T),2)`mm (SD = `r round(sd(LE$growth[which(LE$treatment=='LCO2')] ,na.rm=T),2)`mm). A Welch's two-samples t-test showed that the difference was **not** statistically significant, t(3.38) = 2.629, p > 0.05, d = 1.832.

When this growth data is standardized to initial height (Lirman *et al.* 2014), there is definitely no observable differences (p>0.7).

# Skeletal Density Analysis
![Segmentation of CT-Scan](/notebook/images/ctSegmentation.jpg)

Skeletal density of the corals was measured by CT scanning with a Siemens
Somatom Volume Zoom CT scanner at a resolution of $0.1 \text{mm} \text{ scan}^{-1}$. The three dimensional reconstruction was digitally bisected using the software Amira (ThermoFischer Scientific) at the distance of new growth from the most distal slice of the apical branch.  Materials were assigned 'Old Growth' (red) and 'New Growth' (blue), where 'Old Growth' denotes the portion of the skeleton that was present at the beginning of the experiment and 'New Growth' denotes the portion of the skeleton that is grown under treatment conditions. Because coral growth has vertical and lateral components, the 'Old Growth' material contains the initial skeleton and laterally grown calcium carbonate. However, we are unable to accurately parse apart these two growth forms in this material. Thus, 'New Growth', or the portion of the skeleton that grew above the maximum height of the initial skeleton, is the only section of the coral we can accurately analyze for treatment effect on skeletal density.

$$
\text{Bisected Slice} = \text{Distal Slice} - [(H_f-H_i)*10]
$$
where $H$ is measured in mm, and slices represent 0.1mm of the skeleton's reconstruction.


Then, holes were filled of the reconstruction to enclose the volume of the skeleton to be comparable with methods that determine skeletal density using the buoyant weight technique of wax sealed coral fragments. Finally, the mean brightness of the entire volume of new growth was converted to real-world skeletal density using aragonite density phantoms.

```{r}
ct %>%
  select(material, density, coral, treatment) %>%
  pivot_wider(names_from = material,
              values_from = density) %>%
  kbl(align = 'c',
    digits = 3,
    caption = "Density of bisected coral skeletons in g/cm^3") %>%
  kable_classic() %>%
  row_spec(0, bold = T)


ct %>%
  ggplot(aes(material,density, fill=treatment)) +
  geom_boxplot() +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() +
  labs(title = "Material Skeletal Density ~ Treatment",
       y = expression(paste("Skeletal Density (g ", cm^-3,")")))

ct <- ct %>%
  left_join(LE,
            by=c("coral"="Coral",
                 "treatment")) %>%
  mutate(density.std = density/days)

ct %>%
  ggplot(aes(material,density.std, fill=treatment)) +
  geom_boxplot() +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() +
  labs(title = "Data Standardized to Days in Experiment",
       y = expression(paste("Standardized Skeletal Density (g ", cm^-3, day^-1, ")"))) 

```

New Growth is less dense than Old Growth which makes sense as the Old Growth contains the initial skeleton present at the beginning of the experiment with the addition of lateral thickening. Further, New Growth contains the fast growing apical branch which is less dense than the basal portion of the colony.

There is, however, an interesting trend of corals grown under LCO2 (or control) treatments being less dense than corals grown under HCO2. This trend is apparent for both New Growth and Old Growth. One interpretation is that the treatment group had significant effect on both the vertical extension and the lateral thickening of coral growth, and thus treatment effect is apparent in both the 'New Growth' and 'Old Growth' materials. As mentioned before, this was to be expected, however we cannot parse apart skeleton grown under treatment conditions in the Old Growth section.

It is important to remember that the skeletal density is also a factor of the coral’s growth and not solely its treatment group. Therefore, we should standardize the density to a metric reflective of the coral’s influence on its density to subtract the variability of the coral’s growth from its treatment effect. When this is done, we begin to see significant differences in standardized skeletal density among treatment groups both in the New Growth and Old Growth materials.


## Statistical Testing

### Both Materials

```{r}
ct_test <- ct %>%
  t_test(density.std ~ treatment, var.equal=F)

ggqqplot(ct, x = "density.std", facet.by = "treatment") +
  labs(title = "Data are approximately normal")
ct %>%
  group_by(treatment) %>%
  shapiro_test(density.std)
ct %>%
  levene_test(density.std ~ treatment)

ct_test %>%
  kbl(align = 'c',
    digits = 3,
    caption = "Welch's T-Test Results of Standardized Density of Both Materials") %>%
  kable_classic() %>%
  row_spec(0, bold = T)


ct %>%
  cohens_d(growth ~ treatment, var.equal=F) %>%
  kbl(align = 'c',
    digits = 3,
    caption = "Effect Size Results of Standardized Density of Both Materials") %>%
  kable_classic() %>%
  row_spec(0, bold = T)
```

The mean standardized density in the HCO2 group was `r round(mean(ct$density.std[which(ct$treatment=='HCO2')] ,na.rm=T),2)` (SD = `r round(sd(ct$density.std[which(ct$treatment=='HCO2')] ,na.rm=T),2)`), whereas the mean in LCO2 group was `r round(mean(ct$density.std[which(ct$treatment=='LCO2')] ,na.rm=T),2)` (SD = `r round(sd(ct$density.std[which(ct$treatment=='LCO2')] ,na.rm=T),2)`). A Welch's two-samples t-test showed that the difference was statistically significant, t(17.17) = -4.628, p < 0.001, d = 1.974.

### New Growth

Now, let's just analyze the new growth material.

```{r }

ctNew_test <- ct %>%
  filter(material=='NewGrowth') %>%
  t_test(density.std ~ treatment, var.equal=F)

ggqqplot(ct %>% filter(material=='NewGrowth'),
         x = "density.std", facet.by = "treatment") +
  labs(title = "Data are approximately normal")
ct %>%
  filter(material=='NewGrowth') %>%
  group_by(treatment) %>%
  shapiro_test(density.std)
ct %>%
  filter(material=='NewGrowth') %>%
  levene_test(density.std ~ treatment)

ctNew_test  %>%
  kbl(align = 'c',
    digits = 3,
    caption = "Welch's T-Test Results of Standardized Density of New Growth") %>%
  kable_classic() %>%
  row_spec(0, bold = T)


ct %>%
  filter(material=='NewGrowth') %>%
  cohens_d(growth ~ treatment, var.equal=F) %>%
  kbl(align = 'c',
    digits = 3,
    caption = "Effect Size Results of Standardized Density of New Growth") %>%
  kable_classic() %>%
  row_spec(0, bold = T)

```

When looking at just the new growth, the mean standardized density in the HCO2 group was `r round(mean(ct$density.std[which(ct$treatment=='HCO2' & ct$material=='NewGrowth')] ,na.rm=T),2)` (SD = `r round(sd(ct$density.std[which(ct$treatment=='HCO2' & ct$material=='NewGrowth')] ,na.rm=T),2)`), whereas the mean in LCO2 group was `r round(mean(ct$density.std[which(ct$treatment=='LCO2' & ct$material=='NewGrowth')] ,na.rm=T),2)` (SD = `r round(sd(ct$density.std[which(ct$treatment=='LCO2' & ct$material=='NewGrowth')] ,na.rm=T),2)`). A Welch's two-samples t-test showed that the difference was statistically significant, t(6.71) = -3.62, p < 0.01, d = 1.832.

# Genotype Variability

Finally, it is important to compare the variability of the population to the variability of a genoype within that population to begin to understand genotype-specific sensitivities. Here, I compare 3 ramets of P-Lirman grown under LCO2 conditions and compare it to all LCO2 corals

```{r}

genos <- ct %>%
  filter(genotype=='P-Lirman') %>%
  bind_rows(ct %>%
             filter(treatment=='LCO2') %>%
             mutate(genotype = "Everything Else"))

genos %>%
  ggplot(aes(genotype,density.std, fill=material)) +
  geom_boxplot() +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() +
  labs(title = "Material Skeletal Density ~ Genotype",
       y = expression(paste("Standardized Skeletal Density (g ", cm^-3, day^-1, ")"))) 

genos %>%
  filter(material=='NewGrowth') %>%
  bartlett.test(density.std ~ genotype, data = .)

```

From this data, the variance of standardized skeletal density among the genotype P-Lirman is certainly less than the variance of the population, and there is a statistically significant difference between these two groups' variances. However, I am shying away from making any claims of genotypic variability due to the small sample sizes and lack of genotype replication throughout the experiment design.

