---
layout: post
title:  "ULink 2022 Genotype x OA Growth Analysis"
author: "Patrick M Kiel"
date: '2022-08-03'
categories: [research]
description: "Growth analysis of corals in the University of Miami ULINK Genotype x ocean acidifcation experiment to test for mechanisms of resilience to global change within the critically endangered Acropora cervicornis."
output:
  md_document:
    variant: gfm
    preserve_yaml: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, 
  encoding = encoding, 
  output_file = paste0("2022-08-03-",
                        gsub(pattern = "\\.Rmd$",
                              "", basename(inputFile))
                        ,".md"), 
  output_dir = "../_posts") })
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#load packages
library(tidyverse)
library(kableExtra)
library(googlesheets4)
library(seacarb)
library(emmeans)
library(ggpubr)
library(rstatix)
library(openxlsx)
library(lubridate)
library(scales)

base_dir <- "C:/Users/pkiel/Github/notebook/" # i.e. where the jekyll blog is on the hard drive.
base_url <- "/notebook/" # subdirectory of patrickmkiel.com
fig_path <- "images/ulinkGrowth2022/" #add a new folder if you want to group output into a single foder

# Set base directories
knitr::opts_knit$set(base.dir = base_dir, base.url = base_url)

# Set figure directories
knitr::opts_chunk$set(fig.path = fig_path,
                    cache.path = '../cache/',
                    fig.align = 'center', out.width = '90%',
                    message=FALSE, warning=FALSE,
                    cache = FALSE)
```

```{js}
window.onload = function() {
    //query string in the password
    const urlParams = new URLSearchParams(window.location.search);
    const pass = urlParams.get('pass')
    document.getElementById("password").value = pass;
};


function verify() {
  <!-- set the password here -->
  if (document.getElementById('password').value === 'ulink') {
    document.getElementById('HIDDENDIV').classList.remove("hidden"); 
    document.getElementById('credentials').classList.add("hidden"); // Hide the div containing the credentials
  } else {
    alert('Invalid Password! You cannot view this content.');
    password.setSelectionRange(0, password.value.length);
  }
  return false;
}
```

```{css}
/*Change content Display */
.hidden {
  display: none;
}
```

<!-- The password box -->
<div id="credentials">
  <input type="text" id="password" onkeydown="if (event.keyCode == 13) verify()" />
  <br/>
  <input id="button" type="button" value="Show Content" onclick="verify()" />
</div>

<!-- The content we want to show after password -->
<div id="HIDDENDIV" class="hidden" markdown="1">

<!-- Place all chunks, text, etc here as you would a normal RMarkdown document -->

# Overview
Here I review the growth we have observed in our experiment. The total growth was less than we anticipated, but we still produced enough new skeleton with significant differences in growth rates and sensitivities to proceed forward with most of our tests.

# Treatment Conditions

## Labview Data

```{r load labview}
#load data
pH <- list.files(pattern = "(.*)(_PHData.xlsx$)",
                path = "~/Grad School/ULink 2022/ERLLabView/",
                full.names = T) %>%
  #remove files that begin with ~
  magrittr::extract(which(str_detect(.,"~",negate = T))) %>%
  lapply(., function(x) {
    x %>%
      readxl::read_excel(.,
                         col_types = c("text", "numeric", "numeric", 
                                       "numeric", "numeric", "numeric", 
                                       "numeric", "numeric", "numeric", 
                                       "numeric", "numeric", "numeric", 
                                       "numeric", "numeric", "numeric", 
                                       "numeric", "numeric"))
  }) %>%
  bind_rows() %>%
  distinct() %>%
  mutate(time = convertToDateTime(Time, origin = "1904-01-01",
                                  tz = "America/New_York")) %>%
  select(time, 
         `13` = `Untitled 12`,
         `14` = `Untitled 13`,
         `15` = `Untitled 14`,
         `16` = `Untitled 15`) %>%
  pivot_longer(cols = `13`:`16`,
               names_to = "tank",
               values_to = "pH")

temp <- list.files(pattern = "_TemperatureData.xlsx$",
                   path = "~/Grad School/ULink 2022/ERLLabView/",
                   full.names = T) %>%
  #remove files that begin with ~
  magrittr::extract(which(str_detect(.,"~",negate = T))) %>%
  lapply(., function(x) {
    x %>%
      readxl::read_excel(.,
                         col_types = c("text", "numeric", "numeric", 
                                       "numeric", "numeric", "numeric", 
                                       "numeric", "numeric", "numeric", 
                                       "numeric", "numeric", "numeric", 
                                       "numeric", "numeric", "numeric", 
                                       "numeric", "numeric"))
  }) %>%
  bind_rows() %>%
  distinct() %>%
  mutate(time = convertToDateTime(Time, origin = "1904-01-01",
                                  tz = "America/New_York")) %>%
  select(time, 
         `13` = `Untitled 12`,
         `14` = `Untitled 13`,
         `15` = `Untitled 14`,
         `16` = `Untitled 15`) %>%
  pivot_longer(cols = `13`:`16`,
               names_to = "tank",
               values_to = "temp")

setPoints <- readxl::read_excel('~/Grad School/ULink 2022/pHFinalOscillation.xlsx') %>%
  pivot_longer(control:treat,
               names_to = "type",
               values_to = "pH.set")

labViewData <- full_join(pH,temp, by=c("time", "tank")) %>%
  arrange(time) %>%
  #convert UTC to EST
  mutate(time = with_tz(time, 
                        "America/New_York"),
         hour = hour(time),
         type = case_when(
           tank %in% c(13,15) ~ "treat",
           TRUE ~ "control")) %>%
  #add in set points
  left_join(setPoints,
            by=c("type","hour"="time")) %>%
  select(-c(type,hour))
```

```{r diel pot}
labViewData %>%
  #only use data once treatment conditions met 4/1
  filter(date(time) > as.Date("2022-04-01")) %>%
  drop_na() %>%
  mutate(hms = as.POSIXct(format(time,
                           format="%H:%M:%S"), 
                           format = "%H:%M:%S",
                           tz = "America/New_York"),
          #scale temp to fit on same graph
          temp = temp *  0.0625 + 6.45) %>%
  group_by(hms = round_date(hms, "10 minutes"), tank) %>%
  summarise(pH.mean = mean(pH,na.rm=T),
            pH.sd = sd(pH,na.rm=T),
            temp.mean = mean(temp,na.rm=T),
            temp.sd = sd(temp,na.rm=T)) %>%
  ggplot(aes(hms)) +
  geom_smooth(aes(y=pH.mean, color="pH"),
              se = F, span=0.5) +
  geom_ribbon(aes(ymin=pH.mean-pH.sd,
                  ymax=pH.mean+pH.sd,
                  fill="pH"), alpha=0.3) + 
  geom_line(aes(y=temp.mean, color="Temp")) +
  geom_ribbon(aes(ymin=temp.mean-temp.sd,
                ymax=temp.mean+temp.sd,
                fill="temp"),alpha=0.3) + 
  scale_y_continuous(
    # Features of the first axis
    name = "pH",
    breaks = seq(7.8,8.2,by=0.2),
    minor_breaks = seq(7.7,8.2,by=0.05),
    limits = c(7.7,8.2),
    # Add a second axis and specify its features
    sec.axis = sec_axis(~(.- 6.45) / 0.0625, 
                        name="Temperature")
  ) + 
  scale_x_datetime("Hour",
                   limits = as.POSIXct(strptime(c("00:00",
                                                  "23:59"),
                                                format = "%H:%M")),
                   breaks = seq(as.POSIXct("00:00", format="%H:%M"),
                                as.POSIXct("24:00", format="%H:%M"),
                                by = "3 hours"),
                   #expand = c(0,0),
                   labels = date_format("%H")) +
  facet_wrap(~tank) +
  theme_bw() +
  guides(fill = FALSE) +
  labs(title = "15-min Averaged Log")
```

The peaks in the standard deviation are almost certainly caused by aquarium cleaning days when corals are removed into a separate bath and the sensors are capped causing logging errors. CO2 injection is turned off during these times so the aquariums themselves are not experiencing the conditions that the logged data are suggesting. The following graph filters out these spiked values which were programmatically identified by occurring during scheduled cleaning times and affecting multiple aquariums at once since cleaning occurred at the same time for all aquariums.

```{r cleaned diel plot}
#gather times affected by cleaning of aquarium
#corals are placed in a separate bath and are not affected by the rapid swing
#cleaned during the week, between 9a and 6p
#defined when multiple tanks affected
cleaningTimes <- labViewData %>%
  filter(date(time) > as.Date("2022-04-01")) %>%
  group_by(tank) %>%
  filter(weekdays(time) %in% weekdays(ISOdate(1, 1, 1:5)) &
           between(hour(time),9,18) &
           abs(pH-pH.set)>0.05) %>%
  ungroup() %>%
  group_by(time = round_date(time, "30 minutes")) %>%
  filter(length(unique(tank))>1)

labViewData %>%
  #only use data once treatment conditions met 4/1
  filter(date(time) > as.Date("2022-04-01")) %>%
  drop_na() %>%
  filter(!round_date(time, "30 minutes") %in% cleaningTimes$time) %>%
  #durafet swapped T14 4/22 9:30a-16:30
  filter(!(between(time,
                 as.POSIXct("2022-04-22 09:30:00",
                            tz="America/New_York"),
                 as.POSIXct("2022-04-22 16:30:00",
                            tz="America/New_York")) & tank==14)) %>%
  #durafet swapped T15 7/8 
    filter(!(between(time,
                 as.POSIXct("2022-07-08 14:13:00",
                            tz="America/New_York"),
                 as.POSIXct("2022-07-08 19:30:00",
                            tz="America/New_York")) & tank==15)) %>%
  mutate(hms = as.POSIXct(format(time,
                           format="%H:%M:%S"), 
                           format = "%H:%M:%S",
                           tz = "EST"),
          #scale temp to fit on same graph
          temp = temp *  0.0625 + 6.45) %>%
  group_by(hms = round_date(hms, "10 minutes"), tank) %>%
  summarise(pH.mean = mean(pH,na.rm=T),
            pH.sd = sd(pH,na.rm=T),
            temp.mean = mean(temp,na.rm=T),
            temp.sd = sd(temp,na.rm=T)) %>%
  ggplot(aes(hms)) +
  geom_smooth(aes(y=pH.mean, color="pH"),
              se = F, span=0.5) +
  geom_ribbon(aes(ymin=pH.mean-pH.sd,
                  ymax=pH.mean+pH.sd,
                  fill="pH"), alpha=0.3) + 
  geom_line(aes(y=temp.mean, color="Temp")) +
  geom_ribbon(aes(ymin=temp.mean-temp.sd,
                ymax=temp.mean+temp.sd,
                fill="temp"),alpha=0.3) + 
  scale_y_continuous(
    # Features of the first axis
    name = "pH",
    breaks = seq(7.8,8.2,by=0.2),
    minor_breaks = seq(7.7,8.2,by=0.05),
    limits = c(7.7,8.2),
    # Add a second axis and specify its features
    sec.axis = sec_axis(~(.- 6.45) / 0.0625, 
                        name="Temperature")
  ) + 
  scale_x_datetime("Hour",
                   limits = as.POSIXct(strptime(c("00:00",
                                                  "23:59"),
                                                format = "%H:%M")),
                   breaks = seq(as.POSIXct("00:00", format="%H:%M"),
                                as.POSIXct("24:00", format="%H:%M"),
                                by = "3 hours"),
                   labels = date_format("%H")) +
  facet_wrap(~tank) +
  theme_bw() +
  guides(fill = FALSE) +
  labs(title = "15-min Averaged Log")
```

Variability is still present, but the extreme spikes caused by cleaning have been removed. Thus, any variability that remains is due to durafet error or experimental variability that affected the corals. For example, the durafet for T15 had much higher variability than the other aquariums. However, I believe this to be negligible.

## Carbonate Chemistry Data

500mL water samples were collected every Tuesday for analysis of the complete carbonate chemistry suite. 

```{r load data from google sheets}
googlesheets4::gs4_auth("patrick.kiel@noaa.gov")
ERL <- read_sheet("https://docs.google.com/spreadsheets/d/1Y8L0S9jOiYVoWzMCHqiuJm4vPZARVMvh56td83SO9BA/edit#gid=0",
                  col_types = "-Ddcdd---d------------------") %>%
  rename_with(tolower) %>%
  drop_na(`bottle id`) %>%
  #filter the tanks in your experiment
  #PMK OAxGenotype2022 = 13-16
  filter(tank %in% paste0('T',13:16)) %>%
  #combine date and time columns
  mutate(date = parse_datetime(paste(date,
                                     (time-time%%100)/100,
                                     ifelse(time%%100 == 0, "00", time%%100)),
                               format = "%Y-%m-%d %H %M",
                               locale = locale(tz = "America/New_York"))) %>%
  #for some reason some T15,T16 times aren't parsing fill down
  fill(date) %>%
  select(-c(time), temp.ERL = `tank temp`, pH.ERL = `erl ph`, tag = `bottle id`)
```

```{r load data from carb database}
#load data from Bottle Database - Final_Query_with_Spec_pH
#one day will be SQL from Mike's DB
carbSystem <- read.csv("~/Grad School/ULink 2022/carbonateChemistry/carbData.csv") %>%
  filter(ID_Sample %in% ERL$tag) %>%
  select(tag = ID_Sample,
         DIC.kg = Avg_DIC_Kg_CORRECTED,
         TA.kg = Avg_TA_Kg_CORRECTED,
         sal = Calcdsalinity,
         pH.spec = CORRECTED_pH) %>%
  mutate(across(everything(), ~ as.numeric(.))) %>%
  left_join(ERL,
            by = "tag")  %>%
#solve carbonate system
  mutate(carb(flag = 15, #flag 15 for Alkalinity and DIC, respectively
       var1 = TA.kg/1000000, 
       var2 = DIC.kg/1000000,
       S= sal,
       T = temp.ERL,
       #use all default constants as recommended by Dickson et al. (2007) 
       k1k2 = "l",
       kf = "pf",
       ks = "d", 
       pHscale="T",
       b = "u74")) %>%
  select(tank,date,tag,
         DIC.kg,TA.kg,sal,
         pH.spec,pH.ERL,temp.ERL,
         pH.solved=pH,pCO2,omega=OmegaAragonite,HCO3,CO3)
```

### Time of Day
The bottles were not taken at exactly the same time of day, and thus the programmed variability will be apart of the variability of each sample along with sampling error, durafet error altering amount of CO2 injected into aquaria (shown above in  the LabView data), etc.

```{r}
carbSystem %>%
  mutate(hms = as.POSIXct(format(date,
                           format="%H:%M:%S"), 
                           format = "%H:%M:%S",
                           tz = "America/New_York")) %>%
  group_by(date = date(date(date))) %>%
  summarise(hms = mean(hms,na.rm = T)) %>%
  ggplot(aes(date, hms)) +
  geom_point() +
  theme_bw() +
  labs(x = "Date",
       y = "Time of Day",
       title = "Bottle Sampling of Aquariums")
```

Sampling time had a mean of  around 10a. 3 sampling times were taken after 12p with one sampling time around 4:20p

## Carb Parameters
```{r carbsystem}
carbSystem %>%
  #only use data once treatment conditions met 4/1
  filter(date(date) > as.Date("2022-04-01")) %>%
  select(tank, sal, temp = temp.ERL, TA = TA.kg, DIC = DIC.kg, pCO2, omega) %>%
  group_by(tank) %>%
  summarise(across(everything(),
                    ~ paste(format(round(mean(., na.rm=T),2),nsmall = 2),
        format(round(sd(.,na.rm = T)/sqrt(n()),2),nsmall = 2),
        sep = " ± "))) %>%
  kbl(align = 'c',
    digits = 4,
    caption = "Aquarium Conditions. Means ± SEM") %>%
  kable_classic() %>%
  row_spec(0, bold = T)
  
```

## Statistics

```{r carb statistics}
carbTbl <- carbSystem %>%
  #only use data once treatment conditions met 4/1
  filter(date(date) > as.Date("2022-04-01")) %>%
  select(tank, sal, temp = temp.ERL, TA = TA.kg, DIC = DIC.kg, pCO2, omega) %>%
  mutate(treatment = case_when(tank %in% c('T13','T15') ~ 'HCO2',
                               TRUE ~ 'LCO2')) %>%
  pivot_longer(sal:omega,
               names_to = "parameter") %>%
  group_by(parameter) %>%
  nest() %>%
  mutate(mod = map(data, ~aov(data = .,
                    formula = value ~ treatment/tank))) %>%
  mutate(model_tidy = map(mod, broom::tidy)) %>%
  unnest(model_tidy) %>%
  select(-c(data,mod)) %>%
  mutate(significance = case_when(p.value <0.001 ~ "xxx",
                                  p.value <0.01 ~ "xx",
                                  p.value <0.05 ~ "x",
                                  TRUE ~ "NS"))

carbTbl %>%
    kbl(align = 'c',
    digits = 3,
    caption = "Significance of Parameters") %>%
  kable_classic() %>%
  row_spec(which(carbTbl$p.value<0.05),
           bold = T,
           color = "white",
           background = "red")
```

Salinity, temperature, and total alkalinity were not significantly different between treatments or within treatments (p>>0.05). DIC, pCO2, and $$\Omega_{Ar} $$ (p<0.001) were significantly different between treatment, but not between aquariums (p>>0.05). In other words, our system reproducibly altered the carbonate chemistry parameters with high precision.


# Calcification Analysis

```{r load buoyant weight data}
#selet the authorized tokens
googledrive::drive_auth("p.kiel98@gmail.com")
gs4_auth("p.kiel98@gmail.com")

#load data from google drive
bw <- googledrive::drive_ls(path = "~/GradSchool/ULink_OAxGenotype/",
                            pattern = "buoyantWeight$") %>%
  read_sheet(col_types = "Dcdddc") %>%
  mutate(tag = as.character(tag)) %>%
  drop_na(mass)

#load tank assignment + genotype data
assignment <- read.csv('~/Grad School/ULink 2022/tankAssignment.csv') %>%
  filter(treatment != "") %>%
  mutate(tag = as.character(tag),
         tank = as.factor(tank))

bw <- bw %>%
  left_join(assignment, by="tag") %>%
  arrange(tank, genotype,tag,date) %>%
  filter(date > as.Date("2022-03-15"))
  

#calculate weight in air
bw <- bw %>%
  mutate(
    #calculate sw density (g/cm3) from YSI, p taken as std atm p
    density = rho(S = salinity,
                          T = temp)/1000) %>%
  mutate(
    #calculate weight in air using Jokiel et al. 1978 eqn
    mass_a = mass/(1-density/2.93)) %>%
  select(-c(mass,temp,salinity, density))

#calculate weekly growth rate for QA/QC
weeklyGrowth <- bw %>%
  #week of 05/27/2022 had lots of QC issues, removing data
  filter(!date %in% c(as.Date('2022-05-27'))) %>%
  drop_na(genotype, mass_a) %>%
  group_by(tag = as.numeric(tag)) %>%
  mutate(weekNum = as.numeric(date-first(date))/7,
            newGrowth.mg = ifelse(mass_a!=first(mass_a),
                                  (mass_a - lag(mass_a))*1000,
                                  NA),
            weeklyG.day = ifelse(mass_a!=first(mass_a),
                                  #average daily growth for the week
                                  #mg/g/day, normalized to initial mass
                                  newGrowth.mg /
                                    first(mass_a)/as.numeric(date-lag(date)),
                                  NA),
            weeklyG.week = ifelse(mass_a!=first(mass_a),
                                      #average weekly growth
                                      #mg/g/week, normalized to initial mass
                                      newGrowth.mg/
                                 first(mass_a)/(as.numeric(date-lag(date))/7),
                                      NA)) %>%
  #remove tags that have no weekly growth, i.e. died early on
  group_by(tag) %>%
  filter(!all(is.na(weeklyG.day)))

#corals to check
#weird growth
#10, 63, 103,
#likely broke
#120, 49

#calculate total growth
totalGrowth <- bw %>%
  #set starting date
  filter(date > as.Date("2022-04-15")) %>%
  #remove standards
  drop_na(genotype,mass_a) %>%
  group_by(tag,genotype,tank, treatment) %>%
  summarise(days = as.numeric(last(date)-first(date)),
            newGrowth.mg = (last(mass_a) - first(mass_a))*1000,
            initMass = first(mass_a),
            dailyG = #mg/g/day, normalized to initial mass
                           newGrowth.mg/initMass/days,
            .groups="drop")
```


```{r growth graphs}
weeklyGrowth %>%
  group_by(weekNum,genotype) %>%
  summarise(weeklyG = mean(weeklyG.week, na.rm = T),
            se = sd(weeklyG.week, na.rm = T)/sqrt(n())) %>%
  filter(!is.nan(weeklyG)) %>%
  ggplot(aes(weekNum,weeklyG)) +
  geom_line(aes(color=genotype)) +
  geom_ribbon(aes(ymin = weeklyG - se,
                    ymax = weeklyG + se,
                    fill=genotype),
                alpha=0.3) + 
  labs(title = "Avg Weekly Growth Per Week by Genotype ± se") +
  scale_x_continuous("Week",
                     breaks = c(seq(1,
                                    max(weeklyGrowth$weekNum, na.rm = T),
                                    by=1))) +
  scale_y_continuous("Avg Weekly Growth Rate (mg/g/week)",
                     limits = c(0,40),
                     breaks = c(seq(0,40,by=10)),
                     expand = c(0, 0)) +
  theme_classic()

weeklyGrowth %>%
  group_by(weekNum,treatment) %>%
  summarise(weeklyG = mean(weeklyG.week, na.rm = T),
            se = sd(weeklyG.week, na.rm = T)/sqrt(n())) %>%
  filter(!is.nan(weeklyG)) %>%
  ggplot(aes(as.integer(weekNum),weeklyG)) +
  geom_line(aes(color=treatment)) +
  geom_ribbon(aes(ymin = weeklyG - se,
                    ymax = weeklyG + se,
                    fill=treatment),
                alpha=0.3) + 
  labs(title = "Avg Weekly Growth Per Week by Treatment Group ± se") +
  scale_x_continuous("Week",
                     breaks = c(seq(1,
                                    max(weeklyGrowth$weekNum, na.rm = T),
                                    by=1))) +
  scale_y_continuous("Avg Weekly Growth Rate (mg/g/week)",
                     limits = c(0,40),
                     breaks = c(seq(0,40,by=10)),
                     expand = c(0, 0)) +
  theme_classic()
```

Following April 15 (Weeky 5), the declining health of the corals stabilized and began to split amongst treatment groups.

```{r calcification graphs}
totalGrowth %>%
  ggplot(aes(treatment, dailyG)) +
  geom_boxplot() +
  labs(x = "Treatment",
       y = "Avg Daily Growth Rate (mg/g/day)",
       title = "Avg Daily Growth byTreatment") +
  theme_classic()


totalGrowth %>%
  ggplot(aes(genotype, dailyG)) +
  geom_boxplot(aes(fill=treatment)) +
              #if quantile lines desired: draw_quantiles = c(0.25, 0.5, 0.75)) +
  labs(x = "Genotype",
       y = "Avg Daily Growth Rate (mg/g/day)",
       title = "Avg Daily Growth by Genotype and Treatment") +
  theme_classic()
```

There is some obvious genet-specific responses.

1. Cheetos-B calcification rate was nearly identical across HCO2 and LCO2 groups. This genet also had high initial mortality and the worst survivorship rate throughout the experiment. It is entirely possible that this genotype did not do well in the aquariums and its diminished calcification rate is an effect of overall health and not treatment.

2. SI-A and AC-2 had the highest average calcification rates and there was no significant difference between these two genotypes. However, when you look at the effect of treatment within these genotypes (sensitivity), there is significant differences between them.

3. When looking at just controls, the only significant different genotype is Cheetos-B. Thus, there is a difference in sensitivity to OA but no observable differences in ambient conditions. 

4. The relative rankings extracted from the ol' AcDC are SI-A ~ MB-C > AC-2 > Cheetos-B. The data collected here fits within that framework, yet reveals intraspecifc differences in sensitivities similar to Enochs et al. (2018). Genet identities are unknown for that paper though.

```{r calcification stats}
groupMeans <- totalGrowth %>%
  group_by(treatment) %>%
  get_summary_stats(dailyG, type = "mean_sd")

groupMeans %>%
  select(-variable) %>%
      kbl(align = 'c',
    digits = 4,
    caption = "Means of Treatment") %>%
  kable_classic() %>%
  row_spec(0, bold = T)

tTestResults <- totalGrowth %>% 
  t_test(dailyG ~ treatment, var.equal = T) %>%
  add_significance()

tTestResults %>%
  kbl(align = 'c',
    digits = 4,
    caption = "Stats of Treatment",
    escape=F) %>%
  kable_classic() %>%
  row_spec(0, bold = T)

cohensResults <- totalGrowth %>% 
  cohens_d(dailyG ~ treatment, var.equal = T) 

cohensResults %>%
      kbl(align = 'c',
    digits = 4,
    caption = "Effect Size of Treatment") %>%
  kable_classic() %>%
  row_spec(0, bold = T)

#fixed effects model
mod <- totalGrowth %>%
  aov(dailyG ~ treatment*genotype,
                 data=.)

tukeyGTbl <- mod %>%
  TukeyHSD() %>%
  broom::tidy() %>%
    filter(contrast %in% c('LCO2-HCO2',
                        'Cheetos-B-AC-2',
                        'MB-C-AC-2,',
                        'SI-A-AC-2',
                        'MB-C-Cheetos-B',
                        'SI-A-Cheetos-B',
                        'SI-A-MB-C',
                        'LCO2:AC-2-HCO2:AC-2',
                        'LCO2:Cheetos-B-HCO2:Cheetos-B',
                        'LCO2:MB-C-HCO2:MB-C',
                        'LCO2:SI-A-HCO2:SI-A')) %>%
  select(term,contrast,adj.p.value) %>%
  mutate(significance = case_when(adj.p.value <0.001 ~ "xxx",
                                  adj.p.value <0.01 ~ "xx",
                                  adj.p.value <0.05 ~ "x",
                                  TRUE ~ "NS"),
         adj.p.value = round(adj.p.value, digits=4)) %>%
  arrange(adj.p.value)

tukeyGTbl %>%
  kbl(align = 'c',
    digits = 4,
    caption = "TukeyHSD Results of Anova",
    escape = TRUE) %>%
  kable_classic() %>%
  row_spec(0, bold = T) %>%
  row_spec(which(tukeyGTbl$adj.p.value<0.05),
         bold = T,
         color = "white",
         background = "red")
  
multcomp::cld(emmeans(mod,
                      list(pairwise ~ treatment*genotype),
                      adjust = "tukey"),
              Letters = letters) %>%
  select(treatment, genotype, significance = .group) %>%
    kbl(align = 'c',
    digits = 4,
    caption = "Significance Letter Groups") %>%
  kable_classic() %>%
  row_spec(0, bold = T)
```

The mean calcification rate in the HCO2 group was mean `r round(mean(totalGrowth$dailyG[which(totalGrowth$treatment=='HCO2')]),3)`  (SD = `r round(sd(totalGrowth$dailyG[which(totalGrowth$treatment=='HCO2')]),3)`) mg/g/day, whereas the mean in the LCO2 group was `r round(mean(totalGrowth$dailyG[which(totalGrowth$treatment=='LCO2')]),3)` (SD = `r round(sd(totalGrowth$dailyG[which(totalGrowth$treatment=='LCO2')]),3)`). A Student two-samples t-test showed that the difference was statistically significant, t(`r tTestResults$df`) = `r round(tTestResults$statistic,3)`, p < 0.0001, d = `r round(cohensResults$effsize,3)`. Thus, the ocean acidification group saw on average a `r round((groupMeans$mean[2]-groupMeans$mean[1])/groupMeans$mean[2]*100,0)`% reduction in calcification rates.

## Tank Effects

We saw above that tank conditions were significantly different among treatment groups, but not individual aquariums within treatment. We also saw that calcification rates were significantly different among treatment. Here I am analyzing tank effects on the calcification rate and investigating if calcification rates were significantly different between aquariums within the same treatment group.

```{r tank effects graph}
manLegend <- c("13 HCO2"= "#e46e65",
              "14 LCO2"= "#88b57f",
              "15 HCO2"= "#e46e65",
              "16 LCO2" = "#88b57f")

totalGrowth %>%
  mutate(tank = case_when(tank == 13 ~ "13 HCO2",
                          tank == 14 ~ "14 LCO2",
                          tank == 15 ~ "15 HCO2",
                          tank == 16 ~ "16 LCO2")) %>%
  ggplot(aes(tank, dailyG)) +
  geom_boxplot(aes(fill=tank)) +
  scale_fill_manual(values = manLegend) +
  labs(x = "Genotype",
       y = "Avg Daily Growth Rate (mg/g/day)",
       title = "Avg Daily Growth by Tank and Treatment") +
  theme_classic()

totalGrowth %>%
  mutate(tank = case_when(tank == 13 ~ "13 HCO2",
                          tank == 14 ~ "14 LCO2",
                          tank == 15 ~ "15 HCO2",
                          tank == 16 ~ "16 LCO2")) %>%
  ggplot(aes(genotype, dailyG)) +
  geom_boxplot(aes(fill=tank)) +
  scale_fill_manual(values = manLegend) +
  labs(x = "Genotype",
       y = "Avg Daily Growth Rate (mg/g/day)",
       title = "Avg Daily Growth by Genotype,Treatment, and Tank") +
  theme_classic()
```

### Tank Effects Statistics

```{r tank effects statistics}
totalGrowth %>%
  group_by(treatment) %>%
  nest() %>%
  mutate(mod = map(data, ~aov(data = .,
                    formula = dailyG ~ tank))) %>%
  mutate(model_tidy = map(mod, broom::tidy)) %>%
  unnest(model_tidy) %>%
  select(-c(data,mod)) %>%
  mutate(significance = case_when(p.value <0.001 ~ "xxx",
                                  p.value <0.01 ~ "xx",
                                  p.value <0.05 ~ "x",
                                  TRUE ~ "NS")) %>%
    kbl(align = 'c',
    digits = 3,
    caption = "Significance testing of tank effect on calcification") %>%
  kable_classic() %>%
  row_spec(0, bold = T)

genos <- unique(totalGrowth$genotype)
pairwiseString <- c(paste0('(',
                         genos,
                         ' HCO2) - (',
                         genos,
                         ' LCO2)'),
                    paste0('(HCO2 ',
                         genos,
                         ') - (LCO2 ',
                         genos,
                         ')'))
```

#### Mixed Effects Model

Here I created a random intercept model to include tank effect, i.e. including variability within tanks into the model. This decreased the AIC from 66 to 31, and therefore the random tank effect should be included for analysis. 

As a reminder, here is the fixed effects model as shown above:

```{r fixed effects reminder, echo=T}
modFixed <- totalGrowth %>%
  aov(dailyG ~ genotype*treatment, data=.)

modFixed %>%
  summary()
```

Here is the mixed effects model with the tank set as a random factor to give each tank its own, random interept. Notice, including the random effects decreases the absolute value of the AIC. Therefore, this new model better describes the data.
```{r random mixed effects, echo=T}
modRandom <- totalGrowth %>%
  lmerTest::lmer(dailyG ~ genotype * treatment + (1|tank),
                 data=.)
modRandom %>%
  anova()

AIC(modFixed, modRandom)


emmeans(modRandom, list(pairwise ~genotype*treatment),
        adjust = "tukey")[[2]] %>%
  broom::tidy() %>%
  filter(`1` %in% pairwiseString) %>%
  select(-term) %>%
  rename(pairwise=`1`) %>%
  kbl(align = 'c',
    digits = 4,
    caption = "Pairwise comparison of genotypes' sensitivity to OA",
    escape=F) %>%
  kable_classic() %>%
  row_spec(0, bold = T)
```


## Powder Available

```{r powder available}
totalGrowth %>%
  ggplot(aes(x=genotype, y=newGrowth.mg)) +
  geom_point(aes(color=treatment)) +
  scale_y_continuous(limits = c(0,1000)) +
  geom_hline(yintercept = 50, color="red") +
  geom_hline(yintercept = 120, color="orange") +
  geom_hline(yintercept = 500, color="green") +
  labs(title = "Amount of New CaCO3 Precipated",
       y = "Precipated Skeleton (mg)") +
  theme_classic()
```

The amount of new aragonite precipated is visualized above. Horizontal lines denote thresholds for tests: >500mg = green (complete suite including XRD), >120 mg = orange (complete suite sans XRD), >50mg = red (TGA and isotope only).

# Linear Extension

```{r import LE data}
height <- read.csv('~/Grad School/ULink 2022/initialHeights.csv') %>%
  mutate(date=as.Date("2022-02-25")) %>%
  select(tag,height=height.mm,date) %>%
  left_join(read.csv('~/Grad School/ULink 2022/height06102022.csv') %>%
              mutate(date=as.Date("2022-06-10"),
                     .after="height"),
            by="tag") %>%
  select(tag:date.y) %>%
  left_join(read.csv('~/Grad School/ULink 2022/height07152022.csv'),
            by="tag") %>%
  mutate(height.z=height,
         date.z=as.Date("2022-07-15")) %>%
  select(-height) %>%
  pivot_longer(!tag,
               names_to = '.value',
               names_pattern = '(.*)\\.',
               values_drop_na = T) %>%
  drop_na() %>%
  arrange(tag,date) %>%
  group_by(tag) %>%
  summarise(init.mm = min(height),
            fin.mm = max(height),
            days = as.numeric(date[which.max(height)]-first(date))) %>%
  filter(days!=0) %>%
  mutate(prod = (fin.mm-init.mm)/(init.mm/10)/days,
         LE = fin.mm-init.mm) %>%
  left_join(assignment %>%
              mutate(tag = as.numeric(tag)),
            by="tag")

```

```{r LE graphs}
height %>%
  ggplot(aes(treatment, prod)) +
  geom_boxplot() +
  labs(x = "Treatment",
       y = "Avg Daily LE Rate (mm/cm/day)",
       title = "Avg Daily Linear Extension by Treatment") +
  theme_classic()


height %>%
  ggplot(aes(genotype, prod)) +
  geom_boxplot(aes(fill=treatment)) +
              #if quantile lines desired: draw_quantiles = c(0.25, 0.5, 0.75)) +
  labs(x = "Genotype",
       y = "Avg Daily LE Rate (mm/cm/day)",
       title = "Avg Daily Linear Extension by Genotype and Treatment") +
  theme_classic()
```

```{r LE stats}

groupMeans <- height %>%
  group_by(treatment) %>%
  get_summary_stats(prod, type = "mean_sd")

groupMeans %>%
  select(-variable) %>%
      kbl(align = 'c',
    digits = 4,
    caption = "Means of Treatment") %>%
  kable_classic() %>%
  row_spec(0, bold = T)

tTestResults <- height %>% 
  t_test(prod ~ treatment, var.equal = T) %>%
  add_significance()

tTestResults %>%
  kbl(align = 'c',
    digits = 4,
    caption = "Stats of Treatment",
    escape=F) %>%
  kable_classic() %>%
  row_spec(0, bold = T)

cohensResults <- height %>% 
  cohens_d(prod ~ treatment, var.equal = T) 

cohensResults %>%
      kbl(align = 'c',
    digits = 4,
    caption = "Effect Size of Treatment") %>%
  kable_classic() %>%
  row_spec(0, bold = T)

#fixed effects model
mod <- height %>%
  aov(prod ~ treatment*genotype,
                 data=.) 

tukeyLE <- mod %>%
  TukeyHSD() %>%
  broom::tidy() %>%
  filter(contrast %in% c('LCO2-HCO2',
                        'Cheetos-B-AC-2',
                        'MB-C-AC-2,',
                        'SI-A-AC-2',
                        'MB-C-Cheetos-B',
                        'SI-A-Cheetos-B',
                        'SI-A-MB-C',
                        'LCO2:AC-2-HCO2:AC-2',
                        'LCO2:Cheetos-B-HCO2:Cheetos-B',
                        'LCO2:MB-C-HCO2:MB-C',
                        'LCO2:SI-A-HCO2:SI-A')) %>%
  select(term,contrast,adj.p.value) %>%
  mutate(significance = case_when(adj.p.value <0.001 ~ "xxx",
                                  adj.p.value <0.01 ~ "xx",
                                  adj.p.value <0.05 ~ "x",
                                  TRUE ~ "NS"),
         adj.p.value = round(adj.p.value, digits=4)) %>%
  arrange(adj.p.value)

tukeyLE %>%
    kbl(align = 'c',
    digits = 4,
    caption = "TukeyHSD Results of Anova",
    escape = F) %>%
  kable_classic() %>%
  row_spec(0, bold = T) %>%
  row_spec(which(tukeyLE$adj.p.value<0.05),
       bold = T,
       color = "white",
       background = "red")

multcomp::cld(emmeans(mod,
                      list(pairwise ~ treatment*genotype),
                      adjust = "tukey"),
              Letters = letters) %>%
  select(treatment, genotype, significance = .group) %>%
    kbl(align = 'c',
    digits = 4,
    caption = "Significance Letter Groups") %>%
  kable_classic() %>%
  row_spec(0, bold = T)
```

The mean linear extension rate in the HCO2 group was mean `r round(mean(height$prod[which(height$treatment=='HCO2')]),3)`  (SD = `r round(sd(height$prod[which(height$treatment=='HCO2')]),3)`) mm/cm/day, whereas the mean in the LCO2 group was `r round(mean(height$prod[which(height$treatment=='LCO2')]),3)` (SD = `r round(sd(height$prod[which(height$treatment=='LCO2')]),3)`). A Student two-samples t-test showed that the difference was not statistically significant, t(`r tTestResults$df`) = `r round(tTestResults$statistic,3)`, p =0.124, d = `r round(cohensResults$effsize,3)`. 

```{r total extension}
height %>%
  ggplot(aes(x=genotype, y=LE)) +
  geom_point(aes(color=treatment)) +
  scale_y_continuous(limits = c(0,30)) +
  geom_hline(yintercept = mean(height$LE),
             color="red") +
  labs(title = "Amount of New Skeleton and Mean New LE (Red Line)",
       y = "Linear Extension (mm)") +
  theme_classic()
```

# Takeaways and Next Steps

Overall growth was less than hoped for. However, there is enough new skeleton for nearly all the powder tests that we want to conduct: FTIR, TGA, boron isotopes, and Raman. There is enough powder to run XRD on some samples from genotypes AC-2 (OA=2, control=8) and SI-A (control=5) and a single sample of Cheetos-B. The lack of even replication though may preclude analysis of XRD. For nanoindentation tests, we should have enough new growth to run on a majority of samples.

Linear extension was measured by maximum vertical height as measured with calipers. We additionally have initial 3d scans of all corals and post 3d scans of a subset of 48 corals (n=3 per genotype per tank). From this data, we can extract surface area to volume ratios and see how this changed among genotypes and treatments. This analysis still needs to be done. We can also more accurately measure total linear extension of the corals which may have curving or branching morphologies.

## Plating of Tissue
Among control corals, I visually noticed significant plating of tissue and a veneer of aragonite above the acrylic tags. This was almost completely absent in OA corals. I can take photos of each coral and calculate surface area of plating.

## CT Scanning
The micro-ct scan is currently out of service. We can use the large ct-scanner to determine bulk density. The scanner has a resolution of 0.1mm/scan so we can measure the density of the new growth. This growth is isolated to the highly variable apical tips which may cause some problems. <a href="https://patrickmkiel.com/notebook/research/LangdonSkeletonAnalysis/?pass=acidification" target="_blank">See this post which discusses the ct-scanning analysis of apical tips done on Langdon's OA corals.</a> 


</div>
